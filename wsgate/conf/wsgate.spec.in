%define rel @GITREV@%{?dist}
%define systemddir /lib/systemd/system

##
## OS detection
##
%if 0%{?opensuse_bs}
%define is_el 0%{?centos_version}%{?rhel_version}
%else
%define is_el %(test -n "`echo %{?dist}|grep el`" && echo 1 || echo 0)
%endif
%define is_rh %(test -n "`echo %{?dist}|grep rh`" && echo 1 || echo 0)
%define is_fc 0%{?fedora}%{?fedora_version}
%define is_suse 0%{?suse_version}
%define is_sles 0%{?sles_version}
%define is_mdv 0%{?mdkversion}

Summary: FreeRDP-WebConnct gateway
Name:    wsgate
Version: @VERSION@
Release: %{rel}
License: LGPL
%if %{is_sles}%{is_suse}
Group: Productivity/Networking/Other
%else
Group: Network Servers
%endif
URL: https://github.com/FreeRDP/FreeRDP-WebConnect
Source0: %{name}-%{version}.tar.gz
%if 0%{?opensuse_bs}
Source99: %{name}.rpmlintrc
%endif
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(id -u -n)
Buildrequires: openssl-devel, pcre-devel, boost-devel, ehs-devel, freerdp-devel, libpng-devel
Buildrequires: doxygen, graphviz, automake, libtool, make, gcc-c++, java, perl

%if %{is_fc}
Buildrequires: elfutils-devel
%endif
%if %{is_suse}%{is_sles}
%if %{suse_version} > 1130
Buildrequires: libdw-devel
%endif
%endif

Requires: logrotate, perl

%description
A WebSockets gateway for FreeRDP-WebConnect

%prep
%setup -q

%build
%configure --enable-warn --with-pic
%{__make} %{?_smp_mflags} V=1

%install
%{__make} DESTDIR=%{buildroot} install
%{__install} -m 0755 conf/keygen.sh %{buildroot}%{_libexecdir}/wsgate
%if %{is_el}%{is_fc}
mkdir -p %{buildroot}%{_sysconfdir}/rsyslog.d
echo "local6.*  /var/log/wsgate" > %{buildroot}%{_sysconfdir}/rsyslog.d/wsgate.conf
%endif
mkdir -p %{buildroot}%{_sysconfdir}/logrotate.d
cat > %{buildroot}%{_sysconfdir}/logrotate.d/wsgate <<EOF
/var/log/wsgate
{
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
EOF
mkdir -p  %{buildroot}/var/run/%{name}
%if %{is_el}
mkdir -p %{buildroot}%{_initrddir}
%{__install} -m 0755 conf/initrc.redhat %{buildroot}%{_initrddir}/wsgate
%endif
%if %{is_sles}%{is_suse}
mkdir -p %{buildroot}%{_initrddir}
%{__install} -m 0755 conf/initrc.suse %{buildroot}%{_initrddir}/wsgate
ln -s %{_initrddir}/wsgate  %{buildroot}%{_sbindir}/rcwsgate
%endif
%if %{is_fc}
mkdir -p %{buildroot}%{systemddir}
%{__install} -m 0755 conf/wsgate.service %{buildroot}%{systemddir}
%endif

%clean
%{__rm} -rf %{buildroot}

%pre
getent group wsgate >/dev/null || groupadd -r wsgate || :
getent passwd wsgate >/dev/null || \
  useradd -c "FreeRDP WebConnect Gateway" -g wsgate -s /sbin/nologin \
  -s /sbin/nologin -r -d /var/empty/wsgate wsgate 2> /dev/null || :

%if %{is_fc}
%post
if [ $1 -eq 1 ] ; then
    /bin/systemctl enable wsgate.service >/dev/null 2>&1 || :
fi

%preun
if [ $1 -eq 0 ] ; then
    # Package removal, not upgrade
    /bin/systemctl --no-reload disable wsgate.service > /dev/null 2>&1 || :
    /bin/systemctl stop wsgate.service > /dev/null 2>&1 || :
fi

%postun
/bin/systemctl daemon-reload >/dev/null 2>&1 || :
if [ $1 -ge 1 ] ; then
    # Package upgrade, not uninstall
    /bin/systemctl try-restart wsgate.service >/dev/null 2>&1 || :
fi
%endif

%if %{is_el}%{is_sles}
%post
if [ $1 -eq 1 ] ; then
    /sbin/chkconfig --add wsgate
fi

%preun
if [ $1 -eq 0 ] ; then
    # Package removal, not upgrade
    /sbin/chkconfig --del wsgate
fi

%postun
if [ $1 -ge 1 ] ; then
    # Package upgrade, not uninstall
    /sbin/service wsgate condrestart
fi
%endif

%if %{suse_version} > 1140
%post
if [ $1 -eq 1 ] ; then
    /sbin/chkconfig --add wsgate
fi

%preun
%stop_on_removal

%postun
%restart_on_update
%insserv_cleanup
%endif

%files
%defattr(-,root,root,-)
%{_sbindir}/*
%{_datadir}/*
%config(noreplace) %{_sysconfdir}/logrotate.d/wsgate
%config(noreplace) %{_sysconfdir}/wsgate.ini.sample
%if %{is_el}%{is_fc}
%config(noreplace) %{_sysconfdir}/rsyslog.d/wsgate.conf
%endif
%if %{is_fc}
%{systemddir}/*
%else
%{_initrddir}/wsgate
%endif
%defattr(0755,root,root,-)
%dir %{_libexecdir}/%{name}
%{_libexecdir}/%{name}/keygen.sh
%defattr(4755,root,root,-)
%{_libexecdir}/%{name}/bindhelper
%defattr(-,wsgate,wsgate,-)
%dir /var/run/%{name}

%changelog
